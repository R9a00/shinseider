# 補助金データベース役割分担とアーキテクチャ

## データベースファイルの役割分担

### 1. subsidy_master.yaml - マスターデータベース
**役割**: Single Source of Truth (SSOT) - データの正の真理の源
- **完全なメタデータ**: バージョン管理、変更履歴、参照元情報
- **システム情報**: 作成日、更新日、優先度、アクティブ状態
- **フォームデータ**: sections, validation, checklist, tasks
- **LLMプロンプト**: llm_prompt_template, diagnosis_expense_examples
- **データ整合性**: 5次元整合性チェックの対象

### 2. subsidies.yaml - API用軽量データ
**役割**: フロントエンド表示・API応答用の最適化データ
- **軽量構造**: 必要最小限のメタデータ
- **高速レスポンス**: APIエンドポイント用に最適化
- **フォームデータ**: マスターから自動生成、完全に同期
- **表示用**: application_period, support_amount等の表示情報

### 3. version_history.yaml - バージョン管理
**役割**: 変更履歴とバージョントラッキング
- **変更履歴**: 誰が、いつ、何を変更したか
- **バージョン番号**: semantic versioning対応
- **参照日管理**: 情報の鮮度追跡

## データフロー

```
┌─────────────────┐    自動生成    ┌─────────────────┐
│                 │ ──────────────► │                 │
│ subsidy_master  │                 │   subsidies     │
│ .yaml           │                 │   .yaml         │
│ (マスター)      │                 │   (API用)       │
└─────────────────┘                 └─────────────────┘
         │                                   │
         │                                   │
         ▼                                   ▼
┌─────────────────┐                 ┌─────────────────┐
│ version_history │                 │  Frontend/API   │
│ .yaml           │                 │   Endpoints     │
│ (履歴管理)      │                 │                 │
└─────────────────┘                 └─────────────────┘
```

## APIエンドポイント設計

### 新しいエンドポイント構造
- `/subsidies` → subsidies.yaml (軽量・高速)
- `/subsidies/{id}/application-questions` → subsidy_master.yaml (完全データ)
- `/subsidies/{id}/metadata` → subsidy_master.yaml (メタデータ)
- `/subsidies/{id}/version-history` → version_history.yaml (履歴)

### 従来のエンドポイント
- `/get_application_questions/{id}` → 非推奨（互換性のため維持）

## データベース管理システム

### SubsidyDatabaseManager クラス
- **統合管理**: 全ファイルの一元管理
- **自動同期**: マスター→API用データの自動生成
- **バックアップ**: 変更前の自動バックアップ
- **整合性チェック**: データ整合性の自動検証

### 主要機能
1. **analyze_current_structure()**: 現在のデータ構造分析
2. **create_unified_database()**: 統合データベース作成
3. **_verify_databases()**: データベース検証
4. **get_database_status()**: 状態監視

## データ整合性保証

### 5次元整合性チェック
1. **information_source**: 情報源の明確性
2. **reflection_logic**: データ反映ロジック
3. **ui_representation**: UI表現の一貫性
4. **expression_method**: 表現方法の統一性
5. **temporal_accuracy**: 時間的正確性

### 自動検証項目
- ファイル存在確認
- データ数の整合性
- ID一致確認
- フォームデータ保持確認
- レスポンス時間チェック

## バージョン管理

### セマンティックバージョニング
- **MAJOR**: 破壊的変更
- **MINOR**: 機能追加
- **PATCH**: バグ修正

### 現在のバージョン
- **システム**: 2.0.0 (統合データベース版)
- **各補助金**: 個別バージョン管理

## 運用ガイドライン

### データ更新手順
1. subsidy_master.yamlを更新
2. SubsidyDatabaseManagerで自動同期実行
3. 整合性チェック実行
4. バックアップ確認

### 禁止事項
- subsidies.yamlの直接編集
- version_history.yamlの手動編集
- バックアップの削除

### 推奨事項
- 定期的な整合性チェック
- 変更前のバックアップ確認
- テストスイートの実行

## トラブルシューティング

### よくある問題
1. **404エラー**: ルーターの読み込み先確認
2. **データ不整合**: 統合システム再実行
3. **フォームデータ欠落**: マスターDBから再生成

### 緊急時対応
1. backups/ディレクトリからの復旧
2. SubsidyDatabaseManagerによる再構築
3. 整合性チェッカーによる検証

## パフォーマンス最適化

### 実装済み最適化
- API用データの軽量化
- フォームデータのオンデマンド読み込み
- バックグラウンドでの整合性チェック

### 今後の改善点
- キャッシュ機構の実装
- 差分更新システム
- リアルタイム同期機能

---

## 統合結果

**成功指標**:
- ✅ マスターDB構築: 6件の補助金データ
- ✅ API用データ生成: 軽量最適化済み
- ✅ フォームデータ保持: 完全に維持
- ✅ データ整合性: 100%一致
- ✅ バックアップ作成: 自動実行

**システム改善**:
- 🚀 データ管理効率: 分散管理から統合管理へ
- 🔧 保守性向上: Single Source of Truth確立
- 📊 整合性保証: 自動検証システム
- 💾 データ安全性: 自動バックアップ
- ⚡ API応答速度: 軽量データによる高速化