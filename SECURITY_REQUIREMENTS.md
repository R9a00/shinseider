# アトツギ甲子園用システム - セキュリティ要件定義書

## 1. 概要

本ドキュメントは、攻撃者の視点での脆弱性分析結果を基に、アトツギ甲子園用システムに必要なセキュリティ要件を定義するものです。

## 2. 攻撃者分析結果

### 2.1 発見された脆弱性

#### 致命的な脆弱性（緊急対応必須）
1. **DoS攻撃の成功**
   - 大量データ送信によるサーバーエラー
   - メモリ枯渇攻撃の可能性
   - 影響度: 高

2. **ファイル操作の脆弱性**
   - パストラバーサル攻撃の可能性
   - システムファイルへの不正アクセス
   - 影響度: 高

3. **入力検証の不備**
   - 任意のデータ型の受信
   - 期待しないデータ構造の処理
   - 影響度: 中

4. **キャッシュ攻撃の脆弱性**
   - ブラウザキャッシュによる情報漏洩
   - サーバーキャッシュによる不正アクセス
   - メモリキャッシュによるデータ露出
   - 影響度: 高

#### 中程度の脆弱性
5. **エラーメッセージの情報漏洩**
   - 内部構造の露出
   - 攻撃者への情報提供
   - 影響度: 中

6. **CORS設定の緩さ**
   - 特定のオリジンのみ許可しているが、開発環境限定
   - 影響度: 低

## 3. セキュリティ要件

### 3.1 入力検証要件

#### REQ-SEC-001: リクエストサイズ制限
- **要件**: すべてのPOSTリクエストのサイズを制限する
- **詳細**:
  - 最大リクエストサイズ: 1MB
  - 個別フィールド最大サイズ: 100KB
  - 配列要素数制限: 最大100個
- **実装方法**: FastAPIのRequestSizeLimitミドルウェア使用

#### REQ-SEC-002: データ型検証
- **要件**: 期待されるデータ型を強制する
- **詳細**:
  - JSONスキーマによる厳密な型チェック
  - 必須フィールドの存在確認
  - ネストされたオブジェクトの検証
- **実装方法**: Pydanticモデルによるバリデーション

#### REQ-SEC-003: ファイル名検証
- **要件**: 安全なファイル名のみを許可する
- **詳細**:
  - 許可される文字: 英数字、ハイフン、アンダースコア
  - 禁止される文字: パス区切り文字（/, \）
  - ファイル名長制限: 最大50文字
- **実装方法**: 正規表現によるパターンマッチング

### 3.2 キャッシュセキュリティ要件

#### REQ-SEC-010: ブラウザキャッシュ制御
- **要件**: ブラウザキャッシュによる情報漏洩を防止する
- **詳細**:
  - Cache-Control: no-store, no-cache ヘッダーの設定
  - Pragma: no-cache ヘッダーの設定
  - Expires: 0 ヘッダーの設定
  - ファイルダウンロード時のキャッシュ無効化
- **実装方法**: FastAPIのResponseヘッダー設定

#### REQ-SEC-011: サーバーキャッシュ制御
- **要件**: サーバー側のキャッシュによる不正アクセスを防止する
- **詳細**:
  - 一時ファイルの即座削除
  - ファイル名のランダム化
  - セッション固有のディレクトリ使用
  - 定期的なキャッシュクリーンアップ
- **実装方法**: 一時ディレクトリとファイル管理

#### REQ-SEC-012: メモリキャッシュ制御
- **要件**: メモリキャッシュによるデータ露出を防止する
- **詳細**:
  - 処理完了後のメモリクリア
  - 大量データ処理時のメモリ制限
  - ガベージコレクションの強制実行
  - メモリ使用量の監視
- **実装方法**: Pythonのgcモジュールとメモリ監視

#### REQ-SEC-013: ファイル内容のサニタイゼーション
- **要件**: 生成されるファイルに悪意のあるコードが含まれないようにする
- **詳細**:
  - JavaScriptコードの除去
  - マクロコードの無効化
  - 外部リンクの除去
  - 実行可能コードの検出と除去
- **実装方法**: ファイル内容のスキャンとフィルタリング

### 3.3 ローカルストレージセキュリティ要件

#### REQ-SEC-014: ローカルストレージの安全な管理
- **要件**: ブラウザのローカルストレージを安全に管理する
- **詳細**:
  - データの自動保存（3秒間隔）
  - ページ離脱時の警告表示
  - 送信成功後の自動クリア
  - データ復元機能の提供
- **実装方法**: React useEffectとlocalStorage API

#### REQ-SEC-015: ローカルストレージの容量制限
- **要件**: ローカルストレージの容量制限に対応する
- **詳細**:
  - 保存データサイズの監視
  - 容量不足時の警告表示
  - 古いデータの自動削除
  - データ圧縮機能の提供
- **実装方法**: ストレージ容量チェックとデータ管理

#### REQ-SEC-016: プライベートブラウジング対応
- **要件**: プライベートブラウジングモードでの動作を保証する
- **詳細**:
  - ローカルストレージ無効時の代替手段
  - メモリ内での一時保存
  - セッションストレージの活用
  - ユーザーへの適切な通知
- **実装方法**: ストレージ可用性チェックと代替実装

### 3.4 エラーハンドリング要件

#### REQ-SEC-004: エラー情報の隠蔽
- **要件**: 詳細なエラー情報を外部に露出しない
- **詳細**:
  - 本番環境では詳細なスタックトレースを非表示
  - 汎用的なエラーメッセージの提供
  - ログファイルへの詳細情報記録
- **実装方法**: カスタム例外ハンドラー

#### REQ-SEC-005: 入力エラーの適切な処理
- **要件**: 不正な入力に対する適切なレスポンス
- **詳細**:
  - HTTP 400 Bad Request の適切な返却
  - エラーメッセージの統一化
  - クライアントへの分かりやすい説明
- **実装方法**: FastAPIのHTTPException使用

### 3.5 ファイル操作セキュリティ要件

#### REQ-SEC-006: 安全なファイルパス
- **要件**: ファイル操作を安全なディレクトリに限定する
- **詳細**:
  - 作業ディレクトリ内のみでのファイル操作
  - 絶対パスの使用禁止
  - パストラバーサル攻撃の防止
- **実装方法**: pathlibによるパス検証

#### REQ-SEC-007: 一時ファイルの管理
- **要件**: 生成されたファイルの適切な管理
- **詳細**:
  - ファイル生成後の自動削除（オプション）
  - ファイルサイズ制限
  - ファイル形式の検証
- **実装方法**: 定期的なクリーンアップ処理

### 3.6 レート制限要件

#### REQ-SEC-008: API呼び出し頻度制限
- **要件**: 過度なAPI呼び出しを制限する
- **詳細**:
  - IPアドレスベースのレート制限
  - 1分間に最大60回のリクエスト
  - 1時間に最大1000回のリクエスト
- **実装方法**: FastAPI-Limiter使用

### 3.7 ログ監視要件

#### REQ-SEC-009: セキュリティログ
- **要件**: セキュリティ関連イベントの記録
- **詳細**:
  - 不正なリクエストの記録
  - エラー発生時の詳細ログ
  - ファイル操作の記録
- **実装方法**: 構造化ログ（JSON形式）

## 4. 実装優先度

### 4.1 緊急対応（即座に実装）
1. REQ-SEC-001: リクエストサイズ制限
2. REQ-SEC-006: 安全なファイルパス
3. REQ-SEC-004: エラー情報の隠蔽
4. REQ-SEC-010: ブラウザキャッシュ制御
5. REQ-SEC-011: サーバーキャッシュ制御
6. REQ-SEC-014: ローカルストレージの安全な管理

### 4.2 高優先度（1週間以内）
7. REQ-SEC-002: データ型検証
8. REQ-SEC-005: 入力エラーの適切な処理
9. REQ-SEC-003: ファイル名検証
10. REQ-SEC-012: メモリキャッシュ制御
11. REQ-SEC-013: ファイル内容のサニタイゼーション
12. REQ-SEC-015: ローカルストレージの容量制限

### 4.3 中優先度（1ヶ月以内）
13. REQ-SEC-008: API呼び出し頻度制限
14. REQ-SEC-009: セキュリティログ
15. REQ-SEC-007: 一時ファイルの管理
16. REQ-SEC-016: プライベートブラウジング対応

## 5. テスト要件

### 5.1 セキュリティテスト
- **ペネトレーションテスト**: 月次実施
- **負荷テスト**: 大量データ送信の検証
- **入力検証テスト**: 不正なデータ型の送信
- **ファイル操作テスト**: パストラバーサル攻撃の検証
- **キャッシュ攻撃テスト**: ブラウザ・サーバー・メモリキャッシュの検証
- **ローカルストレージテスト**: データ保存・復元・削除の検証

### 5.2 継続的監視
- **ログ監視**: セキュリティイベントの自動検出
- **パフォーマンス監視**: 異常なリソース使用の検出
- **エラー率監視**: 急激なエラー増加の検出
- **キャッシュ監視**: 不正なキャッシュアクセスの検出
- **ストレージ監視**: ローカルストレージの使用状況監視

## 6. 運用要件

### 6.1 セキュリティ運用
- **定期的な脆弱性スキャン**: 週次実施
- **セキュリティアップデート**: 月次レビュー
- **インシデント対応**: 24時間体制での対応準備
- **キャッシュ監査**: 定期的なキャッシュ状況の確認
- **ローカルストレージ監査**: ブラウザストレージの状況確認

### 6.2 教育・訓練
- **開発者向けセキュリティ研修**: 年次実施
- **セキュリティコーディングガイドライン**: 常時更新
- **攻撃シナリオの共有**: 定期的な情報共有
- **キャッシュ攻撃の認識**: 開発者への教育
- **ローカルストレージセキュリティ**: 開発者への教育

## 7. コンプライアンス要件

### 7.1 法的要件
- **個人情報保護法**: 準拠
- **不正アクセス禁止法**: 準拠
- **サイバーセキュリティ基本法**: 準拠

### 7.2 業界標準
- **OWASP Top 10**: 準拠
- **CWE/SANS Top 25**: 準拠
- **ISO 27001**: 参考

## 8. リスク評価

### 8.1 リスクマトリックス
| 脆弱性 | 発生確率 | 影響度 | リスクレベル |
|--------|----------|--------|-------------|
| DoS攻撃 | 高 | 高 | 高 |
| ファイル操作 | 中 | 高 | 高 |
| キャッシュ攻撃 | 高 | 高 | 高 |
| ローカルストレージ攻撃 | 中 | 中 | 中 |
| 入力検証 | 高 | 中 | 中 |
| 情報漏洩 | 中 | 中 | 中 |

### 8.2 リスク軽減策
- **技術的対策**: 上記セキュリティ要件の実装
- **運用対策**: 監視・ログ分析の強化
- **人的対策**: セキュリティ教育の実施
- **キャッシュ対策**: 多層防御によるキャッシュ保護
- **ローカルストレージ対策**: データ保護と容量管理

## 9. 更新履歴

| 日付 | 版 | 変更内容 | 担当者 |
|------|----|----------|--------|
| 2024-08-05 | 1.0 | 初版作成 | セキュリティチーム |
| 2024-08-05 | 1.1 | キャッシュ攻撃対策追加 | セキュリティチーム |
| 2024-08-05 | 1.2 | ローカルストレージセキュリティ要件追加 | セキュリティチーム |

---

**注意**: 本ドキュメントは攻撃者の視点での分析結果に基づいて作成されており、実際の攻撃シナリオを想定しています。定期的な見直しと更新が必要です。 